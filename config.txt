# After building `rows`, enforce CC=0 (except opening) and recompute Total
# Build quick lookup by entity
by_entity = {}
for r in rows:
    by_entity.setdefault(r["entity"], {}).update({r["business_line"].strip(): r})

for entity, m in by_entity.items():
    total_row = m.get("Total")
    cib_row   = m.get("CIB")
    iwpb_row  = m.get("IWPB")
    cc_row    = m.get("CC")

    if not total_row:
        continue

    # find all Actual|* keys
    actual_keys = [k for k in total_row.keys() if k.startswith("Actual|")]

    for k in actual_keys:
        if k == "Actual|Opening":
            # keep opening CC from circulation
            continue
        # zero CC for later years
        if cc_row:
            cc_row[k] = 0.0

        # recompute Total = CIB + IWPB + CC
        total_val = 0.0
        if cib_row:
            total_val += float(cib_row.get(k, 0.0) or 0.0)
        if iwpb_row:
            total_val += float(iwpb_row.get(k, 0.0) or 0.0)
        if cc_row:
            total_val += float(cc_row.get(k, 0.0) or 0.0)
        total_row[k] = total_val
