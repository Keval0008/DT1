import os
import zipfile
import xml.etree.ElementTree as ET
from datetime import datetime
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox

# ------------ METADATA HELPERS ------------ #

def clean_iso_datetime(dt_str):
    """
    Convert ISO string like '2025-08-11T04:54:38Z' to '11-Aug-2025 04:54:38'.
    If parsing fails, return original string.
    """
    if not dt_str:
        return None
    try:
        dt_str = dt_str.replace("Z", "")
        dt = datetime.fromisoformat(dt_str)
        return dt.strftime("%d-%b-%Y %H:%M:%S")
    except Exception:
        return dt_str

def format_os_datetime(ts):
    """
    Convert a timestamp (from os.stat) to '11-Aug-2025 04:54:38'.
    """
    if ts is None:
        return None
    dt = datetime.fromtimestamp(ts)
    return dt.strftime("%d-%b-%Y %H:%M:%S")

def get_excel_metadata(file_path, root_input_folder):
    # relative folder path (inside input folder)
    rel_path = os.path.relpath(file_path, root_input_folder)
    folder_name = os.path.dirname(rel_path)
    if folder_name == "":
        # File directly in root folder
        folder_name = os.path.basename(root_input_folder)

    metadata = {
        "folder_name": folder_name,
        "filename": os.path.basename(file_path),
        "creator": None,
        "created_at": None,
        "last_modified_by": None,
        "last_modified_at": None,
        "os_created_at": None,
        "os_modified_at": None,
        "full_path": file_path,
    }

    # OS timestamps
    stats = os.stat(file_path)
    metadata["os_created_at"] = format_os_datetime(stats.st_ctime)
    metadata["os_modified_at"] = format_os_datetime(stats.st_mtime)

    # Excel internal metadata
    try:
        with zipfile.ZipFile(file_path, 'r') as z:
            if "docProps/core.xml" in z.namelist():
                xml_content = z.read("docProps/core.xml")
                tree = ET.fromstring(xml_content)

                ns = {
                    "cp": "http://schemas.openxmlformats.org/package/2006/metadata/core-properties",
                    "dc": "http://purl.org/dc/elements/1.1/",
                    "dcterms": "http://purl.org/dc/terms/",
                }

                creator = tree.find("dc:creator", ns)
                created = tree.find("dcterms:created", ns)
                modified_by = tree.find("cp:lastModifiedBy", ns)
                modified = tree.find("dcterms:modified", ns)

                metadata["creator"] = creator.text if creator is not None else None
                metadata["created_at"] = clean_iso_datetime(created.text) if created is not None else None
                metadata["last_modified_by"] = modified_by.text if modified_by is not None else None
                metadata["last_modified_at"] = clean_iso_datetime(modified.text) if modified is not None else None

    except Exception as e:
        print(f"Error reading metadata for {file_path}: {e}")

    return metadata

def run_extraction(input_folder):
    if not input_folder or not os.path.isdir(input_folder):
        messagebox.showerror("Error", "Please select a valid input folder.")
        return

    all_data = []

    for root_dir, dirs, files in os.walk(input_folder):
        for file in files:
            if file.lower().endswith(".xlsx"):
                file_path = os.path.join(root_dir, file)
                meta = get_excel_metadata(file_path, input_folder)
                all_data.append(meta)

    if not all_data:
        messagebox.showinfo("Info", "No .xlsx files found in the selected input folder.")
        return

    df = pd.DataFrame(all_data)

    # Ask user where to save the output file (location + filename)
    save_path = filedialog.asksaveasfilename(
        defaultextension=".xlsx",
        filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")],
        initialfile="excel_metadata_output.xlsx",
        title="Save metadata Excel as"
    )

    if not save_path:
        # User cancelled the save dialog
        messagebox.showinfo("Cancelled", "Save cancelled. No file was created.")
        return

    try:
        df.to_excel(save_path, index=False)
        messagebox.showinfo("Success", f"Metadata Excel saved:\n{save_path}")
    except Exception as e:
        messagebox.showerror("Error", f"Failed to save Excel file:\n{e}")

# ------------ TKINTER UI ------------ #

def browse_input_folder():
    folder = filedialog.askdirectory()
    if folder:
        input_var.set(folder)

def on_run_click():
    input_folder = input_var.get().strip()
    run_extraction(input_folder)

# Main window
root = tk.Tk()
root.title("Excel Metadata Tool")
root.resizable(False, False)

# Minimal layout: one row for input folder, one button row
frame = tk.Frame(root, padx=10, pady=10)
frame.grid(row=0, column=0)

tk.Label(frame, text="Input Folder:").grid(row=0, column=0, sticky="w")
input_var = tk.StringVar()
tk.Entry(frame, textvariable=input_var, width=45).grid(row=1, column=0, pady=5, sticky="w")
tk.Button(frame, text="Browse", command=browse_input_folder).grid(row=1, column=1, padx=5, pady=5)

tk.Button(frame, text="Run Extraction", command=on_run_click).grid(row=2, column=0, columnspan=2, pady=10)

root.mainloop()
