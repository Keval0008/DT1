import base64
import uuid
from io import BytesIO

import dash
from dash import html, dcc, Input, Output, State, no_update
import dash_bootstrap_components as dbc

from utils.constants import APP_TITLE, TAB_REFERENCE_LABEL, TAB_FINANCIAL_LABEL
from services.run_date_parser import extract_run_date_from_xlsx


app = dash.Dash(__name__, title=APP_TITLE, external_stylesheets=[dbc.themes.FLATLY])
server = app.server


def _upload_box():
    return dcc.Upload(
        id="ref_upload",
        multiple=True,
        children=dbc.Card(
            dbc.CardBody(
                [
                    html.Div(
                        [
                            html.Div("Drag & drop files here", className="fw-semibold"),
                            html.Div("or click to browse (.xlsx)", className="text-muted small"),
                        ],
                        className="text-center",
                    )
                ],
                className="py-4",
            ),
            className="border border-2 border-secondary border-opacity-25",
            style={"borderStyle": "dashed"},
        ),
        style={"width": "100%", "cursor": "pointer"},
    )


def _render_uploaded_files_list(files_store):
    if not files_store:
        return dbc.Alert("No files uploaded yet.", color="secondary", className="mb-0")

    items = []
    for f in files_store:
        badge_color = "success" if f.get("valid") else "danger"
        run_txt = f.get("run_date_display") or "Run date not found"
        items.append(
            dbc.ListGroupItem(
                [
                    html.Div(
                        [
                            html.Span(f.get("filename", ""), className="fw-semibold"),
                            dbc.Badge("Valid" if f.get("valid") else "Invalid", color=badge_color, className="ms-2"),
                        ]
                    ),
                    html.Div(run_txt, className="text-muted small"),
                ],
                className="py-2",
            )
        )

    return dbc.ListGroup(items, flush=True)


def reference_tab_layout():
    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            dcc.Store(id="ref_files_store", storage_type="memory"),

            dbc.Row(
                className="g-3 align-items-stretch",
                children=[
                    # LEFT: Upload & Session Controls (includes uploaded files list)
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Upload & Session Controls", className="fw-semibold"),
                                            html.Span("  •  Upload multiple .xlsx files and manage session", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    className="d-flex flex-column",
                                    children=[
                                        _upload_box(),

                                        html.Div(className="mt-3"),
                                        dbc.Alert(
                                            id="ref_upload_status",
                                            color="info",
                                            className="py-2 mb-3",
                                            children="Upload files to begin.",
                                        ),

                                        dbc.Button(
                                            "Clear Session",
                                            id="ref_clear_session_btn",
                                            color="outline-danger",
                                            className="mb-3",
                                        ),

                                        html.Div(
                                            [
                                                html.Div("Uploaded files in session", className="fw-semibold mb-2"),
                                                html.Div(id="ref_uploaded_files_list"),
                                            ],
                                            className="mt-auto",  # pushes list towards bottom if there’s extra space
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    ),

                    # RIGHT: Current vs Previous selection
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Current vs Previous File Selection", className="fw-semibold"),
                                            html.Span("  •  Auto-picks latest run date as Main", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    children=[
                                        dbc.Alert(
                                            id="ref_current_main_alert",
                                            color="primary",
                                            className="py-2",
                                            children="Current/Main file: —",
                                        ),

                                        html.Div(className="mt-3"),
                                        dbc.Label("Reference file (previous runs only)"),
                                        dcc.Dropdown(
                                            id="ref_reference_dropdown",
                                            options=[],
                                            value=None,
                                            placeholder="Upload at least 2 valid files to select a reference",
                                            clearable=False,
                                        ),

                                        dbc.FormText(
                                            "Only files with a valid run date in row 1 appear here. "
                                            "The latest valid run date becomes the Current/Main file."
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    ),
                ],
            ),
        ],
    )


def financial_tab_layout():
    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            dbc.Card(
                className="shadow-sm",
                children=[
                    dbc.CardHeader(html.Span("Financial Data Check", className="fw-semibold")),
                    dbc.CardBody("Financial Data Check UI will go here."),
                ],
            )
        ],
    )


app.layout = dbc.Container(
    fluid=True,
    className="py-3",
    children=[
        dbc.Row(
            children=[
                dbc.Col(
                    children=[
                        html.H2(APP_TITLE, className="mb-0"),
                        html.Div("Upload, detect current run, compare with a reference run.", className="text-muted"),
                    ]
                )
            ],
            className="mb-3",
        ),

        dcc.Tabs(
            id="main_tabs",
            value="reference_tab",
            children=[
                dcc.Tab(label=TAB_REFERENCE_LABEL, value="reference_tab"),
                dcc.Tab(label=TAB_FINANCIAL_LABEL, value="financial_tab"),
            ],
        ),

        html.Div(id="tab_content", className="mt-3"),
    ],
)


@app.callback(
    Output("tab_content", "children"),
    Input("main_tabs", "value"),
)
def render_tab(tab_value):
    if tab_value == "reference_tab":
        return reference_tab_layout()
    return financial_tab_layout()


@app.callback(
    Output("ref_files_store", "data"),
    Output("ref_upload_status", "children"),
    Output("ref_upload_status", "color"),
    Output("ref_current_main_alert", "children"),
    Output("ref_reference_dropdown", "options"),
    Output("ref_reference_dropdown", "value"),
    Output("ref_uploaded_files_list", "children"),
    Input("ref_upload", "contents"),
    Input("ref_upload", "filename"),
    Input("ref_clear_session_btn", "n_clicks"),
    State("ref_files_store", "data"),
    prevent_initial_call=True,
)
def handle_ref_upload(contents_list, filename_list, clear_clicks, existing_store):
    triggered = dash.callback_context.triggered[0]["prop_id"].split(".")[0]

    # Clear session
    if triggered == "ref_clear_session_btn":
        return (
            None,
            "Session cleared. Upload files to begin.",
            "info",
            "Current/Main file: —",
            [],
            None,
            _render_uploaded_files_list(None),
        )

    if not contents_list or not filename_list:
        return no_update, no_update, no_update, no_update, no_update, no_update, no_update

    existing = existing_store or []
    added = []
    invalid_count = 0

    for contents, fname in zip(contents_list, filename_list):
        try:
            _, b64data = contents.split(",", 1)
            file_bytes = base64.b64decode(b64data)
        except Exception:
            file_bytes = b""

        run_info = extract_run_date_from_xlsx(BytesIO(file_bytes))
        valid = bool(run_info.get("valid"))
        run_dt = run_info.get("run_date_parsed")

        if not valid:
            invalid_count += 1

        added.append(
            {
                "file_id": str(uuid.uuid4()),
                "filename": fname,
                "valid": valid,
                "run_date_raw": run_info.get("run_date_raw"),
                "run_date_iso": run_dt.isoformat() if run_dt else None,
                "run_date_display": run_dt.strftime("%Y-%m-%d %H:%M:%S") if run_dt else "",
            }
        )

    store = existing + added

    # Determine current/main file = latest valid run date
    valid_files = [f for f in store if f.get("valid") and f.get("run_date_iso")]
    current_file = max(valid_files, key=lambda x: x["run_date_iso"]) if valid_files else None

    current_text = (
        f"Current/Main file: {current_file['filename']}  (Run: {current_file['run_date_display']})"
        if current_file
        else "Current/Main file: —"
    )

    # Reference dropdown options = previous valid files (exclude current)
    options = []
    if current_file:
        for f in valid_files:
            if f["file_id"] == current_file["file_id"]:
                continue
            options.append({"label": f"{f['filename']} (Run: {f['run_date_display']})", "value": f["file_id"]})

    # Status message
    msg = f"Uploaded {len(added)} file(s). Total in session: {len(store)}."
    color = "success"
    if invalid_count:
        msg += f" {invalid_count} file(s) had missing/invalid run date in row 1."
        color = "warning"

    uploaded_list_ui = _render_uploaded_files_list(store)

    # Reset dropdown selection on new upload to avoid stale selections
    return store, msg, color, current_text, options, None, uploaded_list_ui


if __name__ == "__main__":
    app.run_server(debug=True)
