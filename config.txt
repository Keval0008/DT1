from typing import List, Optional

import openpyxl


def _norm(s) -> str:
    if s is None:
        return ""
    return str(s).strip().lower()


def detect_header_row(
    path: str,
    expected_columns: List[str],
    max_rows: int = 35,
    max_cols: int = 80,
    sheet_name: Optional[str] = None,
) -> int:
    """
    Auto-detect header row by scanning for max matches of expected column names.
    Returns 1-based row index.
    """
    wb = openpyxl.load_workbook(path, read_only=True, data_only=True)
    ws = wb[sheet_name] if sheet_name and sheet_name in wb.sheetnames else wb[wb.sheetnames[0]]

    expected = set([_norm(c) for c in expected_columns if _norm(c)])
    if not expected:
        raise ValueError("expected_columns is empty")

    best_row = None
    best_score = -1

    for r in range(1, max_rows + 1):
        values = []
        for c in range(1, max_cols + 1):
            v = ws.cell(row=r, column=c).value
            values.append(_norm(v))
        score = sum(1 for v in values if v in expected)

        if score > best_score:
            best_score = score
            best_row = r

    if best_row is None or best_score <= 0:
        raise ValueError("Could not detect header row (no expected columns found). Try manual override.")

    return best_row


def build_column_options(path: str, header_row: int, sheet_name: Optional[str] = None):
    """
    Return dropdown options from header row values.
    """
    wb = openpyxl.load_workbook(path, read_only=True, data_only=True)
    ws = wb[sheet_name] if sheet_name and sheet_name in wb.sheetnames else wb[wb.sheetnames[0]]

    cols = []
    # scan some columns
    for c in range(1, 200):
        v = ws.cell(row=header_row, column=c).value
        if v is None:
            continue
        name = str(v).strip()
        if name and name not in cols:
            cols.append(name)

    return [{"label": c, "value": c} for c in cols]
