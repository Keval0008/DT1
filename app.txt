import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import os
import pandas as pd
import getpass
from datetime import datetime
import math

# Get current user ID
keyword = getpass.getuser()

# List of admin user IDs (modify as needed)
admin_users = ["admin1", "admin2", "superuser"]  # Example user IDs

def select_files():
    files = filedialog.askopenfilenames(title="Select Excel Files", filetypes=[("Excel files", "*.xlsx")])
    file_list.clear()
    file_list.extend(list(files))
    update_stats()

def select_folder():
    folder = filedialog.askdirectory(title="Select Destination Folder")
    if folder:
        folder_path.set(folder)
    update_stats()

def save_files():
    if not file_list:
        update_status("Error: No files selected", "red")
        return
    if not folder_path.get():
        update_status("Error: No folder selected", "red")
        return

    # Get current timestamp in DDMMYYYY_HHMMSS format
    timestamp = datetime.now().strftime("%d%m%Y_%H%M%S")
    
    try:
        for file in file_list:
            # Read the Excel file
            df = pd.read_excel(file)
            
            # Add new columns
            df['Submitted by'] = keyword
            df['Submitted time'] = timestamp
            
            # Get file name and create new name with suffix
            base_name = os.path.basename(file)
            name, ext = os.path.splitext(base_name)
            new_name = f"{name}_{keyword}_{timestamp}{ext}"
            dest_path = os.path.join(folder_path.get(), new_name)
            
            # Save modified Excel file
            df.to_excel(dest_path, index=False)
            
        update_status(f"Success: {len(file_list)} files saved!", "green")
    except Exception as e:
        update_status(f"Error: {str(e)}", "red")
    update_stats()

def update_stats():
    # Update file count and folder in bold
    stats_text = f"Files Selected: {len(file_list)}\nDestination Folder: {folder_path.get() or 'Not selected'}"
    stats_label.config(text=stats_text)

    # Calculate dynamic height based on wrapped text
    base_height = 350  # Minimum height for fixed elements
    wraplength = 450  # Matches wraplength of stats_label
    font_height = 20  # Approximate height per line (Helvetica 10 bold)
    
    # Estimate lines for folder path
    folder_text = folder_path.get() or "Not selected"
    chars_per_line = wraplength // 7  # Approximate chars per line (7 pixels per char)
    folder_lines = max(1, math.ceil(len("Destination Folder: " + folder_text) / chars_per_line))
    
    # Calculate total height: base + extra for wrapped lines
    extra_lines = max(0, folder_lines - 2)  # Assume 2 lines fit in base height
    total_height = base_height + extra_lines * font_height
    
    # Update window geometry (keep width fixed at 500)
    root.geometry(f"500x{int(total_height)}")

def update_status(message, color):
    status_label.config(text=message, fg=color)

def admin_button_action():
    # Placeholder for admin functionality
    messagebox.showinfo("Admin", "Admin button clicked (no action yet).")

# Tkinter UI Setup
root = tk.Tk()
root.title("File Rename & Save")
root.geometry("500x350")  # Initial size
root.configure(bg="#f5f5f5")
root.resizable(False, False)

# Variables
file_list = []
folder_path = tk.StringVar()

# Fonts and Styles
label_font = ("Helvetica", 10)
button_font = ("Helvetica", 10, "bold")
stats_font = ("Helvetica", 10, "bold")  # Bold for stats

# ttk Style for rounded buttons
style = ttk.Style()
style.theme_use("clam")
style.configure("TButton",
                padding=6,
                relief="raised",
                background="#4a90e2",
                foreground="white",
                borderwidth=2,
                borderradius=10)
style.map("TButton",
          background=[("active", "#357ABD")])

# Notebook for tabs
notebook = ttk.Notebook(root)
notebook.pack(padx=20, pady=20, fill="both", expand=True)

# User Tab
user_frame = tk.Frame(notebook, bg="#f5f5f5")
notebook.add(user_frame, text="User")

# Admin Tab (only visible to admin users)
if getpass.getuser() in admin_users:
    admin_frame = tk.Frame(notebook, bg="#f5f5f5")
    notebook.add(admin_frame, text="Admin")
else:
    notebook.tab(0, state="normal")  # Ensure User tab is accessible

# User Tab Content
tk.Label(user_frame, text="File Rename & Save", font=("Helvetica", 14, "bold"), bg="#f5f5f5").pack(pady=10)
ttk.Button(user_frame, text="Select Excel Files", command=select_files, style="TButton").pack(pady=5)
ttk.Button(user_frame, text="Select Folder", command=select_folder, style="TButton").pack(pady=5)
ttk.Button(user_frame, text="Save Files", command=save_files, style="TButton").pack(pady=15)
status_label = tk.Label(user_frame, text="Ready", font=label_font, bg="#f5f5f5", fg="#333333")
status_label.pack(pady=5)
stats_label = tk.Label(user_frame, text="Files Selected: 0\nDestination Folder: Not selected",
                      font=stats_font, bg="#f5f5f5", fg="#333333", justify="left", anchor="nw",
                      wraplength=450)
stats_label.pack(pady=10, fill="x")

# Admin Tab Content (for admins only)
if getpass.getuser() in admin_users:
    tk.Label(admin_frame, text="Admin Panel", font=("Helvetica", 14, "bold"), bg="#f5f5f5").pack(pady=10)
    ttk.Button(admin_frame, text="Admin Action", command=admin_button_action, style="TButton").pack(pady=5)

root.mainloop()
