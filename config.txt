import pandas as pd

def build_target_to_sources_map(df):
    """
    Build a mapping: target_system -> list of source_data
    """
    return df.groupby('target_system')['source_data'].apply(list).to_dict()


def dfs_collect_leaves(mapping, current, visited=None):
    """
    Depth-first search to collect all final source_data values reachable from `current`.

    Rule:
    - From current source, find all rows where target_system == current
    - Move to their source_data values
    - If no further rows, current is a leaf (final value)
    """
    if visited is None:
        visited = set()

    # Detect cycles
    if current in visited:
        # We hit a loop; treat current as a leaf to avoid infinite recursion
        return {current}

    visited.add(current)

    # All next nodes where target_system == current
    children = mapping.get(current, [])

    if not children:
        # No further links â†’ current is a final value
        return {current}

    leaves = set()
    for child in children:
        # Use a copy of visited for each branch
        leaves |= dfs_collect_leaves(mapping, child, visited.copy())

    return leaves


def get_country_reclass_chains(df):
    """
    For each row where title contains 'Country Reclass':
    - Start from its source_data
    - Follow all chains using target_system -> source_data mapping
    - Return all final leaf values reachable from that starting source_data
    """
    results = []

    # Build mapping once
    target_to_sources = build_target_to_sources_map(df)

    # Filter rows where title contains 'Country Reclass' (case-insensitive)
    cr_rows = df[df['title'].str.contains("Country Reclass", case=False, na=False)]

    for idx, row in cr_rows.iterrows():
        start_source = row['source_data']
        start_target = row['target_system']

        final_leaves = dfs_collect_leaves(target_to_sources, start_source)

        results.append({
            "row_index": idx,
            "start_source_data": start_source,
            "start_target_system": start_target,
            # store as list; you can also join as comma-separated string if you like
            "final_chain_values": list(final_leaves)
        })

    return pd.DataFrame(results)
