import pandas as pd

def follow_chain(df, start_source):
    """
    Follow the chain:
    current_source -> find row where target_system == current_source
                   -> update current_source = that row's source_data
    Repeat until no match is found.
    """
    current = start_source
    visited = set()

    while True:
        if current in visited:
            # loop detected, stop to avoid infinite cycle
            break
        visited.add(current)

        # find row(s) where target_system == current source_data
        match = df[df['target_system'] == current]

        if match.empty:
            # no further link
            break

        # if multiple rows match, take the first one
        current = match['source_data'].iloc[0]

    return current


def get_country_reclass_chains(df):
    """
    For each row where title == 'Country Reclass':
    - start_source = source_data
    - follow the chain using follow_chain()
    - return summary as a DataFrame
    """
    results = []

    cr_rows = df[df['title'] == "Country Reclass"]

    for idx, row in cr_rows.iterrows():
        start_source = row['source_data']
        start_target = row['target_system']

        final_value = follow_chain(df, start_source)

        results.append({
            "country_reclass_row_index": idx,
            "start_source_data": start_source,
            "start_target_system": start_target,
            "final_chain_value": final_value
        })

    return pd.DataFrame(results)


# ===== Example usage =====
# df = pd.DataFrame({
#     "source_data": ["A", "X", "P", "Q", "R", "S"],
#     "target_system": ["B", "A", "Q", "R", "S", "T"],
#     "title": ["Country Reclass", "Mapping Rule", "Country Reclass", "Mapping Rule", "Mapping Rule", "Mapping Rule"]
# })
#
# result_df = get_country_reclass_chains(df)
# print(result_df)
