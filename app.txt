import dash_ag_grid as dag
from dash import html
import pandas as pd
import numpy as np

def create_ag_grid_table(
    dataframe, 
    table_id=None, 
    highlight_vars=None, 
    highlight_color='lightyellow',
    default_col_def=None,
    precision=2
):
    """
    Convert a pandas DataFrame to a Dash AG Grid table with optional variable highlighting
    and controlled precision for numerical columns.
    
    Args:
        dataframe: pandas DataFrame to display
        table_id: Optional ID for the table component
        highlight_vars: Optional list of variables to highlight
        highlight_color: Background color for highlighted cells
        default_col_def: Optional dictionary of default column definitions
        precision: Number of decimal places to display for numerical columns
        
    Returns:
        A Dash AG Grid component
    """
    if dataframe.empty:
        return html.Div("No data available")
    
    # Make a copy to avoid modifying the original dataframe
    df = dataframe.copy()
    
    # Apply precision to numerical columns
    float_cols = df.select_dtypes(include=[np.number]).columns
    for col in float_cols:
        df[col] = df[col].round(precision)
    
    # Convert dataframe to dictionary format for AG Grid
    row_data = df.to_dict('records')
    
    # Prepare default column definitions if not provided
    if default_col_def is None:
        default_col_def = {
            "resizable": True,
            "sortable": True,
            "filter": True,
            "editable": False,
            "minWidth": 100
        }
    
    # Create column definitions with formatting and highlighting
    column_defs = []
    for col in df.columns:
        col_def = {"field": col}
        
        # Apply number formatting for numerical columns
        if col in float_cols:
            col_def["valueFormatter"] = {"function": f"params.value != null ? params.value.toFixed({precision}) : ''"}
        
        # Apply highlighting if column is in highlight_vars
        if highlight_vars and col in highlight_vars:
            col_def["cellStyle"] = {"backgroundColor": highlight_color}
            
        column_defs.append(col_def)
    
    grid = dag.AgGrid(
        id=table_id,
        rowData=row_data,
        columnDefs=column_defs,
        defaultColDef=default_col_def,
        dashGridOptions={
            "pagination": True,
            "paginationPageSize": 10,
            "suppressCellFocus": True,
            "animateRows": False
        },
        style={"height": "400px", "width": "100%"},
        columnSize="sizeToFit",
    )
    
    return grid
