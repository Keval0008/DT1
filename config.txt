import base64
import uuid
from io import BytesIO

import dash
from dash import html, dcc, Input, Output, State, no_update
import dash_bootstrap_components as dbc

from utils.constants import (
    APP_TITLE,
    TAB_REFERENCE_LABEL,
    TAB_FINANCIAL_LABEL,
    EXPECTED_COLUMNS_DEFAULT,
    KEY_COLUMN,
)
from services.run_date_parser import extract_run_date_from_xlsx


app = dash.Dash(__name__, title=APP_TITLE, external_stylesheets=[dbc.themes.FLATLY])
server = app.server


def _upload_box():
    return dcc.Upload(
        id="ref_upload",
        multiple=True,
        children=dbc.Card(
            dbc.CardBody(
                [
                    html.Div(
                        [
                            html.Div("Drag & drop files here", className="fw-semibold"),
                            html.Div("or click to browse (.xlsx)", className="text-muted small"),
                        ],
                        className="text-center",
                    )
                ],
                className="py-4",
            ),
            className="border border-2 border-secondary border-opacity-25",
            style={"borderStyle": "dashed"},
        ),
        style={"width": "100%", "cursor": "pointer"},
    )


def _render_uploaded_files_list(files_store):
    if not files_store:
        return dbc.Alert("No files uploaded yet.", color="secondary", className="mb-0")

    items = []
    for f in files_store:
        badge_color = "success" if f.get("valid") else "danger"
        run_txt = f.get("run_date_display") or "Run date not found"
        items.append(
            dbc.ListGroupItem(
                [
                    html.Div(
                        [
                            html.Span(f.get("filename", ""), className="fw-semibold"),
                            dbc.Badge("Valid" if f.get("valid") else "Invalid", color=badge_color, className="ms-2"),
                        ]
                    ),
                    html.Div(run_txt, className="text-muted small"),
                ],
                className="py-2",
            )
        )

    return dbc.ListGroup(items, flush=True)


def _default_compare_columns():
    # Default compare columns = expected columns minus key column
    return [c for c in EXPECTED_COLUMNS_DEFAULT if c != KEY_COLUMN]


def reference_tab_layout():
    compare_default = _default_compare_columns()
    compare_options = [{"label": c, "value": c} for c in compare_default]

    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            # Stores
            dcc.Store(id="ref_files_store", storage_type="memory"),

            # Row 1: Upload + Selection (equal width/height)
            dbc.Row(
                className="g-3 align-items-stretch",
                children=[
                    # LEFT: Upload & Session Controls (includes uploaded files list)
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Upload & Session Controls", className="fw-semibold"),
                                            html.Span("  •  Upload multiple .xlsx files and manage session", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    className="d-flex flex-column",
                                    children=[
                                        _upload_box(),

                                        html.Div(className="mt-3"),
                                        dbc.Alert(
                                            id="ref_upload_status",
                                            color="info",
                                            className="py-2 mb-3",
                                            children="Upload files to begin.",
                                        ),

                                        dbc.Button(
                                            "Clear Session",
                                            id="ref_clear_session_btn",
                                            color="outline-danger",
                                            className="mb-3",
                                        ),

                                        html.Div(
                                            [
                                                html.Div("Uploaded files in session", className="fw-semibold mb-2"),
                                                html.Div(id="ref_uploaded_files_list"),
                                            ],
                                            className="mt-auto",
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    ),

                    # RIGHT: Current vs Previous selection
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Current vs Previous File Selection", className="fw-semibold"),
                                            html.Span("  •  Auto-picks latest run date as Main", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    children=[
                                        dbc.Alert(
                                            id="ref_current_main_alert",
                                            color="primary",
                                            className="py-2",
                                            children="Current/Main file: —",
                                        ),

                                        html.Div(className="mt-3"),
                                        dbc.Label("Reference file (previous runs only)"),
                                        dcc.Dropdown(
                                            id="ref_reference_dropdown",
                                            options=[],
                                            value=None,
                                            placeholder="Upload at least 2 valid files to select a reference",
                                            clearable=False,
                                        ),

                                        dbc.FormText(
                                            "Only files with a valid run date in row 1 appear here. "
                                            "The latest valid run date becomes the Current/Main file."
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    ),
                ],
            ),

            # Row 2: Comparison settings + Run action
            dbc.Row(
                className="g-3 mt-1",
                children=[
                    dbc.Col(
                        md=12,
                        children=dbc.Card(
                            className="shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Comparison Settings", className="fw-semibold"),
                                            html.Span("  •  Key + compare columns + optional header overrides", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    children=[
                                        dbc.Row(
                                            className="g-3",
                                            children=[
                                                dbc.Col(
                                                    md=6,
                                                    children=[
                                                        dbc.Label("Key column"),
                                                        dbc.InputGroup(
                                                            [
                                                                dbc.Input(
                                                                    value=KEY_COLUMN,
                                                                    disabled=True,
                                                                ),
                                                                dbc.InputGroupText("from constants.py"),
                                                            ]
                                                        ),
                                                        dbc.FormText(
                                                            "Used to match rows between Main and Reference. "
                                                            "Kept constant to avoid configuration mistakes."
                                                        ),
                                                    ],
                                                ),
                                                dbc.Col(
                                                    md=6,
                                                    children=[
                                                        dbc.Label("Compare columns (optional)"),
                                                        dcc.Dropdown(
                                                            id="compare_columns_dropdown",
                                                            options=compare_options,
                                                            multi=True,
                                                            placeholder="Leave empty to compare all default columns",
                                                        ),
                                                        dbc.FormText(
                                                            "Default compare list = EXPECTED_COLUMNS_DEFAULT minus KEY_COLUMN."
                                                        ),
                                                    ],
                                                ),
                                            ],
                                        ),

                                        html.Hr(className="my-3"),

                                        # Header override accordion (collapsible)
                                        dbc.Accordion(
                                            start_collapsed=True,
                                            children=[
                                                dbc.AccordionItem(
                                                    title="Header detection overrides (optional)",
                                                    children=[
                                                        dbc.Row(
                                                            className="g-3",
                                                            children=[
                                                                dbc.Col(
                                                                    md=6,
                                                                    children=[
                                                                        dbc.Label("Main header row override (1-based)"),
                                                                        dbc.Input(
                                                                            id="main_header_override",
                                                                            type="number",
                                                                            min=1,
                                                                            step=1,
                                                                            placeholder="Leave empty for auto-detect",
                                                                        ),
                                                                    ],
                                                                ),
                                                                dbc.Col(
                                                                    md=6,
                                                                    children=[
                                                                        dbc.Label("Reference header row override (1-based)"),
                                                                        dbc.Input(
                                                                            id="ref_header_override",
                                                                            type="number",
                                                                            min=1,
                                                                            step=1,
                                                                            placeholder="Leave empty for auto-detect",
                                                                        ),
                                                                    ],
                                                                ),
                                                            ],
                                                        ),
                                                        dbc.FormText(
                                                            "Use this only if auto header detection fails (multiple tables, merged headers, etc.). "
                                                            "Row numbers are Excel-style (1-based)."
                                                        ),
                                                    ],
                                                ),
                                            ],
                                        ),

                                        html.Div(className="mt-3"),

                                        dbc.Row(
                                            className="g-2 align-items-center",
                                            children=[
                                                dbc.Col(
                                                    md=3,
                                                    children=dbc.Button(
                                                        "Run Comparison",
                                                        id="run_compare_btn",
                                                        color="primary",
                                                        className="w-100",
                                                    ),
                                                ),
                                                dbc.Col(
                                                    md=9,
                                                    children=dbc.Alert(
                                                        id="run_compare_status",
                                                        color="secondary",
                                                        className="py-2 mb-0",
                                                        children="Select a reference file, then run comparison.",
                                                    ),
                                                ),
                                            ],
                                        ),
                                    ],
                                ),
                            ],
                        ),
                    )
                ],
            ),
        ],
    )


def financial_tab_layout():
    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            dbc.Card(
                className="shadow-sm",
                children=[
                    dbc.CardHeader(html.Span("Financial Data Check", className="fw-semibold")),
                    dbc.CardBody("Financial Data Check UI will go here."),
                ],
            )
        ],
    )


app.layout = dbc.Container(
    fluid=True,
    className="py-3",
    children=[
        dbc.Row(
            className="mb-3",
            children=[
                dbc.Col(
                    children=[
                        html.H2(APP_TITLE, className="mb-0"),
                        html.Div("Upload, detect current run, compare with a reference run.", className="text-muted"),
                    ]
                )
            ],
        ),

        dcc.Tabs(
            id="main_tabs",
            value="reference_tab",
            children=[
                dcc.Tab(label=TAB_REFERENCE_LABEL, value="reference_tab"),
                dcc.Tab(label=TAB_FINANCIAL_LABEL, value="financial_tab"),
            ],
        ),

        html.Div(id="tab_content", className="mt-3"),
    ],
)


@app.callback(
    Output("tab_content", "children"),
    Input("main_tabs", "value"),
)
def render_tab(tab_value):
    if tab_value == "reference_tab":
        return reference_tab_layout()
    return financial_tab_layout()


# Upload + Current/Main + Reference dropdown
@app.callback(
    Output("ref_files_store", "data"),
    Output("ref_upload_status", "children"),
    Output("ref_upload_status", "color"),
    Output("ref_current_main_alert", "children"),
    Output("ref_reference_dropdown", "options"),
    Output("ref_reference_dropdown", "value"),
    Output("ref_uploaded_files_list", "children"),
    Input("ref_upload", "contents"),
    Input("ref_upload", "filename"),
    Input("ref_clear_session_btn", "n_clicks"),
    State("ref_files_store", "data"),
    prevent_initial_call=True,
)
def handle_ref_upload(contents_list, filename_list, clear_clicks, existing_store):
    triggered = dash.callback_context.triggered[0]["prop_id"].split(".")[0]

    # Clear session
    if triggered == "ref_clear_session_btn":
        return (
            None,
            "Session cleared. Upload files to begin.",
            "info",
            "Current/Main file: —",
            [],
            None,
            _render_uploaded_files_list(None),
        )

    if not contents_list or not filename_list:
        return no_update, no_update, no_update, no_update, no_update, no_update, no_update

    existing = existing_store or []
    added = []
    invalid_count = 0

    for contents, fname in zip(contents_list, filename_list):
        try:
            _, b64data = contents.split(",", 1)
            file_bytes = base64.b64decode(b64data)
        except Exception:
            file_bytes = b""

        run_info = extract_run_date_from_xlsx(BytesIO(file_bytes))
        valid = bool(run_info.get("valid"))
        run_dt = run_info.get("run_date_parsed")

        if not valid:
            invalid_count += 1

        added.append(
            {
                "file_id": str(uuid.uuid4()),
                "filename": fname,
                "valid": valid,
                "run_date_raw": run_info.get("run_date_raw"),
                "run_date_iso": run_dt.isoformat() if run_dt else None,
                "run_date_display": run_dt.strftime("%Y-%m-%d %H:%M:%S") if run_dt else "",
            }
        )

    store = existing + added

    # Determine current/main file = latest valid run date
    valid_files = [f for f in store if f.get("valid") and f.get("run_date_iso")]
    current_file = max(valid_files, key=lambda x: x["run_date_iso"]) if valid_files else None

    current_text = (
        f"Current/Main file: {current_file['filename']}  (Run: {current_file['run_date_display']})"
        if current_file
        else "Current/Main file: —"
    )

    # Reference dropdown options = previous valid files (exclude current)
    options = []
    if current_file:
        for f in valid_files:
            if f["file_id"] == current_file["file_id"]:
                continue
            options.append({"label": f"{f['filename']} (Run: {f['run_date_display']})", "value": f["file_id"]})

    # Upload status
    msg = f"Uploaded {len(added)} file(s). Total in session: {len(store)}."
    color = "success"
    if invalid_count:
        msg += f" {invalid_count} file(s) had missing/invalid run date in row 1."
        color = "warning"

    uploaded_list_ui = _render_uploaded_files_list(store)

    # Reset dropdown selection on new upload
    return store, msg, color, current_text, options, None, uploaded_list_ui


# Run Comparison button (UI-only status + validation)
@app.callback(
    Output("run_compare_status", "children"),
    Output("run_compare_status", "color"),
    Input("run_compare_btn", "n_clicks"),
    State("ref_files_store", "data"),
    State("ref_reference_dropdown", "value"),
    State("compare_columns_dropdown", "value"),
    State("main_header_override", "value"),
    State("ref_header_override", "value"),
    prevent_initial_call=True,
)
def run_comparison_ui_only(n_clicks, files_store, ref_file_id, compare_cols, main_hdr, ref_hdr):
    if not files_store:
        return "Upload files first.", "danger"

    if not ref_file_id:
        return "Select a reference file from previous runs.", "danger"

    # Default compare columns if user leaves empty
    used_compare = compare_cols if compare_cols else _default_compare_columns()

    main_hdr_text = f"{int(main_hdr)}" if main_hdr else "auto-detect"
    ref_hdr_text = f"{int(ref_hdr)}" if ref_hdr else "auto-detect"

    msg = (
        f"Ready to run. Key='{KEY_COLUMN}', "
        f"Compare cols count={len(used_compare)}, "
        f"Header(Main={main_hdr_text}, Ref={ref_hdr_text}). "
        "Next step: connect backend to detect headers, compute diffs, and generate the report."
    )
    return msg, "primary"


if __name__ == "__main__":
    app.run_server(debug=True)
