from typing import Dict

import pandas as pd
from openpyxl import Workbook
from openpyxl.styles import PatternFill, Font, Alignment
from openpyxl.utils.dataframe import dataframe_to_rows


FILL_ADDED = PatternFill("solid", fgColor="C6EFCE")     # light green
FILL_DELETED = PatternFill("solid", fgColor="FFC7CE")   # light red
FILL_MODIFIED = PatternFill("solid", fgColor="FFEB9C")  # light yellow

HEADER_FONT = Font(bold=True)
CENTER = Alignment(vertical="center")


def write_anomaly_report_xlsx(path: str, summary: Dict, anomalies_df: pd.DataFrame) -> None:
    wb = Workbook()

    # Summary sheet
    ws1 = wb.active
    ws1.title = "Summary"

    summary_rows = [
        ("Main file", summary.get("main_file", "")),
        ("Reference file", summary.get("ref_file", "")),
        ("Key column", summary.get("key_column", "")),
        ("Main header row", summary.get("main_header_row", "")),
        ("Reference header row", summary.get("ref_header_row", "")),
        ("Added rows", summary.get("added_rows", 0)),
        ("Deleted rows", summary.get("deleted_rows", 0)),
        ("Modified rows", summary.get("modified_rows", 0)),
        ("Modified cells", summary.get("modified_cells", 0)),
        ("Compare columns used", ", ".join(summary.get("compare_columns_used", []) or [])),
        ("Missing compare cols in main", ", ".join(summary.get("compare_columns_missing_in_main", []) or [])),
        ("Missing compare cols in reference", ", ".join(summary.get("compare_columns_missing_in_ref", []) or [])),
    ]

    ws1.append(["Metric", "Value"])
    ws1["A1"].font = HEADER_FONT
    ws1["B1"].font = HEADER_FONT

    for k, v in summary_rows:
        ws1.append([k, v])

    ws1.column_dimensions["A"].width = 28
    ws1.column_dimensions["B"].width = 80

    # Changes sheet
    ws2 = wb.create_sheet("Changes")
    if anomalies_df is None or anomalies_df.empty:
        ws2.append(["No anomalies found."])
        wb.save(path)
        return

    # Write dataframe
    for r_idx, row in enumerate(dataframe_to_rows(anomalies_df, index=False, header=True), start=1):
        ws2.append(row)
        if r_idx == 1:
            for c in range(1, len(row) + 1):
                ws2.cell(row=r_idx, column=c).font = HEADER_FONT
                ws2.cell(row=r_idx, column=c).alignment = CENTER

    # Style rows based on change type
    # Columns: change_type, key, column_name, old_value, new_value
    change_col = 1
    for r in range(2, ws2.max_row + 1):
        change_type = ws2.cell(row=r, column=change_col).value
        fill = None
        if change_type == "ADDED":
            fill = FILL_ADDED
        elif change_type == "DELETED":
            fill = FILL_DELETED
        elif change_type == "MODIFIED":
            fill = FILL_MODIFIED

        if fill:
            for c in range(1, ws2.max_column + 1):
                ws2.cell(row=r, column=c).fill = fill
                ws2.cell(row=r, column=c).alignment = Alignment(vertical="top", wrap_text=True)

    # Column widths
    widths = [12, 24, 22, 35, 35]
    for i, w in enumerate(widths, start=1):
        ws2.column_dimensions[chr(64 + i)].width = w

    wb.save(path)
