import os
import zipfile
import xml.etree.ElementTree as ET
from datetime import datetime
import pandas as pd

# Set your folder path
folder_path = r"/path/to/your/folder"

def get_excel_metadata(file_path):
    metadata = {
        "folder_name": os.path.basename(os.path.dirname(file_path)),
        "filename": os.path.basename(file_path),
        "creator": None,
        "created_at": None,
        "last_modified_by": None,
        "last_modified_at": None,
        "os_created_at": None,
        "os_modified_at": None
    }

    # OS timestamp
    stats = os.stat(file_path)
    metadata["os_created_at"] = datetime.fromtimestamp(stats.st_ctime)
    metadata["os_modified_at"] = datetime.fromtimestamp(stats.st_mtime)

    try:
        with zipfile.ZipFile(file_path, 'r') as z:
            if "docProps/core.xml" in z.namelist():
                xml_content = z.read("docProps/core.xml")
                tree = ET.fromstring(xml_content)

                ns = {
                    "cp": "http://schemas.openxmlformats.org/package/2006/metadata/core-properties",
                    "dc": "http://purl.org/dc/elements/1.1/",
                    "dcterms": "http://purl.org/dc/terms/",
                }

                creator = tree.find("dc:creator", ns)
                created = tree.find("dcterms:created", ns)
                modified_by = tree.find("cp:lastModifiedBy", ns)
                modified = tree.find("dcterms:modified", ns)

                metadata["creator"] = creator.text if creator is not None else None
                metadata["created_at"] = created.text if created is not None else None
                metadata["last_modified_by"] = modified_by.text if modified_by is not None else None
                metadata["last_modified_at"] = modified.text if modified is not None else None

    except Exception as e:
        print(f"Error reading metadata for {file_path}: {e}")

    return metadata


# Walk all folders and collect results
all_data = []

for root, dirs, files in os.walk(folder_path):
    for file in files:
        if file.endswith(".xlsx"):
            file_path = os.path.join(root, file)
            all_data.append(get_excel_metadata(file_path))

# Convert to DataFrame
df = pd.DataFrame(all_data)

# Save to Excel
output_file = "excel_metadata_output.xlsx"
df.to_excel(output_file, index=False)

print(f"File saved successfully as {output_file}")
