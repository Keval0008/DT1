import pandas as pd
import re

def find_subheader_ranges(df):
    # Identify header columns (assuming 0-indexed columns)
    header_cols = [97, 65, 33, 129]
    
    # Dictionary to store results
    subheader_ranges = {}
    
    # Compile regex patterns for case-insensitive matching
    actual_pattern = re.compile(r'actual', re.IGNORECASE)
    forecast_pattern = re.compile(r'forecast', re.IGNORECASE)
    frp_pattern = re.compile(r'frp', re.IGNORECASE)
    
    for header_col in header_cols:
        # Get the header name from row 0
        header_name = df.iloc[0, header_col]
        
        # Initialize dictionary for this header
        subheader_ranges[header_name] = {}
        
        # Search in row 1 (next row) for subheaders
        row_to_search = 1
        current_row = df.iloc[row_to_search, :]
        
        # Find positions of our keywords with flexible matching
        actual_positions = [
            idx for idx, val in enumerate(current_row) 
            if isinstance(val, str) and actual_pattern.search(val)
        ]
        
        forecast_positions = [
            idx for idx, val in enumerate(current_row) 
            if isinstance(val, str) and forecast_pattern.search(val)
        ]
        
        frp_positions = [
            idx for idx, val in enumerate(current_row) 
            if isinstance(val, str) and frp_pattern.search(val)
        ]
        
        # For each header, find the first keyword occurrence after the header column
        # Actual range
        actual_start = next((x for x in actual_positions if x > header_col), None)
        if actual_start:
            # Find end (either before Forecast or FRP)
            end_candidates = [x for x in forecast_positions + frp_positions if x > actual_start]
            actual_end = min(end_candidates) - 1 if end_candidates else None
            subheader_ranges[header_name]['Actual'] = (actual_start, actual_end)
        
        # Forecast range
        forecast_start = next((x for x in forecast_positions if x > header_col), None)
        if forecast_start:
            # Find end (before FRP)
            end_candidates = [x for x in frp_positions if x > forecast_start]
            forecast_end = min(end_candidates) - 1 if end_candidates else None
            subheader_ranges[header_name]['Forecast'] = (forecast_start, forecast_end)
        
        # FRP range
        frp_start = next((x for x in frp_positions if x > header_col), None)
        if frp_start:
            subheader_ranges[header_name]['FRP'] = (frp_start, None)
    
    return subheader_ranges

# Example usage:
# df = pd.read_excel('your_file.xlsx', header=None)
# ranges = find_subheader_ranges(df)
# print(ranges)
