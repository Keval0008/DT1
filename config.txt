pip install msoffcrypto-tool pandas openpyxl

from io import BytesIO
from pathlib import Path
import msoffcrypto
import pandas as pd

def read_encrypted_excel(path, password, sheet_name=0, **read_kwargs):
    """
    Decrypt an Excel file in memory and read with pandas.

    Args:
        path (str/Path): path to .xlsx or .xls (and .xlsb after decrypt)
        password (str): workbook password
        sheet_name: same as pandas.read_excel (0, name, list, or None for all)
        **read_kwargs: passed through to pandas.read_excel (e.g., dtype=..., usecols=...)

    Returns:
        DataFrame or dict[str, DataFrame] if sheet_name=None
    """
    path = Path(path)

    # Decrypt to memory
    decrypted = BytesIO()
    with open(path, "rb") as f:
        office_file = msoffcrypto.OfficeFile(f)
        office_file.load_key(password=password)
        office_file.decrypt(decrypted)

    # Rewind the buffer so pandas can read it
    decrypted.seek(0)

    # Choose engine if you know the type, else let pandas infer from content
    # For .xlsb (after decrypt), force engine="pyxlsb"
    engine = "pyxlsb" if path.suffix.lower() == ".xlsb" else None

    return pd.read_excel(decrypted, sheet_name=sheet_name, engine=engine, **read_kwargs)

# --- Usage examples ---

# Single sheet (first sheet)
df = read_encrypted_excel("protected.xlsx", password="YourPassword123")
print(df.head())

# Specific sheet by name
orders = read_encrypted_excel("protected.xlsx", password="YourPassword123", sheet_name="Orders")

# All sheets at once (dict of DataFrames)
all_sheets = read_encrypted_excel("protected.xlsx", password="YourPassword123", sheet_name=None)
for name, df in all_sheets.items():
    print(name, df.shape)


import win32com.client as win32
from pathlib import Path

src = Path(r"C:\path\protected.xlsx")
dst = Path(r"C:\path\decrypted.xlsx")

excel = win32.gencache.EnsureDispatch("Excel.Application")
excel.Visible = False
wb = excel.Workbooks.Open(str(src), False, False, None, "YourPassword123")
wb.SaveAs(str(dst), FileFormat=51)  # 51 = .xlsx (xlOpenXMLWorkbook), no password
wb.Close(False)
excel.Quit()

import pandas as pd
df = pd.read_excel(dst)
print(df.head())
