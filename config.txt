import pandas as pd
from xlsxwriter.utility import xl_col_to_name

# ---- your dataframe ----
# df = ...

out_path = "output.xlsx"
with pd.ExcelWriter(out_path, engine="xlsxwriter") as writer:
    df.to_excel(writer, sheet_name="Sheet1", index=False)

    wb  = writer.book
    ws  = writer.sheets["Sheet1"]

    # ---- formats ----
    fmt_thousands_0 = wb.add_format({"num_format": "#,##0"})
    fmt_percent_2   = wb.add_format({"num_format": "0.00%"})
    # 'yyyy' ONLY works if the cell is a true Excel date serial (see note below)
    fmt_year        = wb.add_format({"num_format": "yyyy"})

    # ---- locate columns by name ----
    cols = {name: i for i, name in enumerate(df.columns)}

    # 1) Fixed column formats for totals
    for colname in ["value_in_use", "carrying_value", "headroom"]:
        if colname in cols:
            cidx = cols[colname]
            ws.set_column(cidx, cidx, 14, fmt_thousands_0)

    # 2) No formatting needed for entity, CGU, period, field (skip)

    # 3) Row-wise conditional formatting based on `field`
    #    We’ll format:
    #      - the single `value` column
    #      - the timeseries block from Opening … 2031
    field_col = cols["field"]
    value_col = cols["value"]

    # find start/end of the series block: from "Opening" to "2031"
    series_start_name = "Opening"
    series_end_name   = "2031"
    series_start = cols[series_start_name]
    series_end   = cols[series_end_name]

    # Excel addresses (1-based rows in Excel; header is row 1)
    nrows = len(df)
    data_first_row = 2                # row with first data (after header)
    data_last_row  = nrows + 1

    def col_range(c1, c2):
        a = xl_col_to_name(c1)
        b = xl_col_to_name(c2)
        return f"{a}{data_first_row}:{b}{data_last_row}"

    def col_band(c):
        a = xl_col_to_name(c)
        return f"{a}{data_first_row}:{a}{data_last_row}"

    # helpful absolute reference to the `field` column for the current row
    # If 'field' is column D (zero-based 3), formula will use $D2, etc.
    field_abs_col_letter = xl_col_to_name(field_col)
    fld = f"${field_abs_col_letter}"

    # ---- apply conditional formats ----
    # 3A) If field == "current_year"  -> year format
    #     Apply to the VALUE column only (usually the series cells are blank for this)
    ws.conditional_format(
        col_band(value_col),
        {
            "type": "formula",
            "criteria": f'=LOWER({fld}2)="current_year"',
            "format": fmt_year,
        },
    )

    # 3B) If field contains "rate" -> percentage format
    #     Apply to VALUE and the Opening…2031 block
    rate_formula = f'=ISNUMBER(SEARCH("rate",LOWER({fld}2)))'
    ws.conditional_format(
        col_band(value_col),
        {"type": "formula", "criteria": rate_formula, "format": fmt_percent_2},
    )
    ws.conditional_format(
        col_range(series_start, series_end),
        {"type": "formula", "criteria": rate_formula, "format": fmt_percent_2},
    )

    # 3C) If field contains "rwa" OR "pbt" -> thousands, 0 decimals
    rwa_pbt_formula = (
        f'=OR(ISNUMBER(SEARCH("rwa",LOWER({fld}2))),ISNUMBER(SEARCH("pbt",LOWER({fld}2))))'
    )
    ws.conditional_format(
        col_band(value_col),
        {"type": "formula", "criteria": rwa_pbt_formula, "format": fmt_thousands_0},
    )
    ws.conditional_format(
        col_range(series_start, series_end),
        {"type": "formula", "criteria": rwa_pbt_formula, "format": fmt_thousands_0},
    )

    # (Optional) set some sensible column widths
    ws.set_column(cols["entity"], cols["entity"], 18)
    ws.set_column(cols["CGU"], cols["CGU"], 16)
    ws.set_column(cols["period"], cols["period"], 12)
    ws.set_column(cols["field"], cols["field"], 18)
    ws.set_column(value_col, value_col, 12)
    ws.set_column(series_start, series_end, 12)

