import subprocess
import sys
import time
import webview
import socket

HOST = "127.0.0.1"
PORT = 8501

def is_port_open(host, port):
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.settimeout(0.2)
        return s.connect_ex((host, port)) == 0

def main():
    # Start Streamlit in the background
    p = subprocess.Popen(
        [
            sys.executable, "-m", "streamlit", "run", "app.py",
            "--server.address", HOST,
            "--server.port", str(PORT),
            "--server.headless", "true",
            "--browser.gatherUsageStats", "false",
        ],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )

    # Wait until Streamlit is listening
    for _ in range(200):  # ~20 seconds max (200 * 0.1)
        if is_port_open(HOST, PORT):
            break
        time.sleep(0.1)

    try:
        # Open native window
        webview.create_window(
            "My Streamlit Desktop App",
            f"http://{HOST}:{PORT}",
            width=1200,
            height=800,
        )
        webview.start()
    finally:
        # Close Streamlit when window closes
        p.terminate()

if __name__ == "__main__":
    main()
